<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.adc.da.sys.dao.MenuEODao">
    <!-- Result Map-->
    <resultMap id="BaseResultMap" type="com.adc.da.sys.entity.MenuEO">
        <id column="id" property="id"/>
        <result column="valid_flag" property="validFlag"/>
        <result column="name" property="name"/>
        <result column="parent_id" property="parentId"/>
        <result column="parent_ids" property="parentIds"/>
        <result column="href" property="href"/>
        <result column="icon" property="icon"/>
        <result column="is_show" property="isShow"/>
        <result column="permission" property="permission"/>
        <result column="remarks" property="remarks"/>
        <result column="modify_time" property="modifyTime" />
    	<result column="creation_time" property="creationTime" />
    </resultMap>

    <!-- TS_MENU table all fields -->
    <sql id="Base_Column_List">
        id, valid_flag, name, parent_id, parent_ids, href, icon, is_show, permission, remarks,modify_time, creation_time
    </sql>

    <!-- 查询条件 -->
    <sql id="Base_Where_Clause">
        where 1=1
        <trim suffixOverrides=",">
            <if test="id != null">
                and id ${idOperator} #{id}
            </if>
            <if test="validFlag != null">
                and valid_flag ${validFlagOperator} #{validFlag}
            </if>
            <if test="name != null">
                and name ${nameOperator} #{name}
            </if>
            <if test="parentId != null">
                and parent_id ${parentIdOperator} #{parentId}
            </if>
            <if test="parentIds != null">
                and parent_ids ${parentIdsOperator} #{parentIds}
            </if>
            <if test="href != null">
                and href ${hrefOperator} #{href}
            </if>
            <if test="icon != null">
                and icon ${iconOperator} #{icon}
            </if>
            <if test="isShow != null">
                and is_show ${isShowOperator} #{isShow}
            </if>
            <if test="permission != null">
                and permission ${permissionOperator} #{permission}
            </if>
            <if test="remarks != null">
                and remarks ${remarksOperator} #{remarks}
            </if>
      		<if test="modifyTime != null" >
        		and modify_time ${modifyTimeOperator} #{modifyTime}
      		</if>
      		<if test="modifyTime1 != null" >
        		and modify_time &gt;= #{modifyTime1}
      		</if>
      		<if test="modifyTime2 != null" >
        		and modify_time &lt;= #{modifyTime2}
      		</if>
      		<if test="creationTime != null" >
        		and creation_time ${creationTimeOperator} #{creationTime}
      		</if>
      		<if test="creationTime1 != null" >
        		and creation_time &gt;= #{creationTime1}
      		</if>
      		<if test="creationTime2 != null" >
        		and creation_time &lt;= #{creationTime2}
      		</if>            
        </trim>
    </sql>

    <!-- 插入记录 -->
    <insert id="insert" parameterType="com.adc.da.sys.entity.MenuEO">
		insert into TS_MENU(<include refid="Base_Column_List"/>)
        values (#{id}, #{validFlag}, #{name}, #{parentId}, #{parentIds}, #{href}, #{icon}, #{isShow}, #{permission}, #{remarks},#{modifyTime}, #{creationTime})
    </insert>

	<!-- 动态插入记录 主键是序列 -->
	<insert id="insertSelective" parameterType="com.adc.da.sys.entity.MenuEO" >
		insert into TS_MENU
		<trim prefix="(" suffix=")" suffixOverrides="," >
			<if test="modifyTime != null" >modify_time,</if>
            <if test="creationTime != null" >creation_time,</if>
	        <if test="remarks != null" >remarks,</if>
	        <if test="permission != null" >permission,</if>
	        <if test="isShow != null" >is_show,</if>
	        <if test="icon != null" >icon,</if>
	        <if test="href != null" >href,</if>
	        <if test="parentIds != null" >parent_ids,</if>
	        <if test="parentId != null" >parent_id,</if>
	        <if test="name != null" >name,</if>
	        <if test="validFlag != null" >valid_flag,</if>
	        <if test="id != null" >id,</if>
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides="," >
			<if test="modifyTime != null" >#{modifyTime},</if>
            <if test="creationTime != null" >#{creationTime},</if>
	        <if test="remarks != null" >#{remarks},</if>
	        <if test="permission != null" >#{permission},</if>
	        <if test="isShow != null" >#{isShow},</if>
	        <if test="icon != null" >#{icon},</if>
	        <if test="href != null" >#{href},</if>
	        <if test="parentIds != null" >#{parentIds},</if>
	        <if test="parentId != null" >#{parentId},</if>
	        <if test="name != null" >#{name},</if>
	        <if test="validFlag != null" >#{validFlag},</if>
	        <if test="id != null" >#{id},</if>
		</trim>
	</insert>

    <!-- 根据pk，修改记录-->
    <update id="updateByPrimaryKey" parameterType="com.adc.da.sys.entity.MenuEO">
        UPDATE TS_MENU
        SET valid_flag = #{validFlag},
        NAME = #{name},
        parent_id = #{parentId},
        parent_ids = #{parentIds},
        href = #{href},
        icon = #{icon},
        is_show = #{isShow},
        PERMISSION = #{permission},
        remarks = #{remarks},
        modify_time = #{modifyTime},
        creation_time = #{creationTime}
        WHERE ID = #{id}
    </update>

    <!-- 修改记录，只修改只不为空的字段 -->
    <update id="updateByPrimaryKeySelective" parameterType="com.adc.da.sys.entity.MenuEO">
        update TS_MENU
        <set>
        	<if test="modifyTime != null" >
        		modify_time = #{modifyTime},
      		</if>
      		<if test="creationTime != null" >
        		creation_time = #{creationTime},
      		</if>
            <if test="validFlag != null">
                valid_flag = #{validFlag},
            </if>
            <if test="name != null">
                name = #{name},
            </if>
            <if test="parentId != null">
                parent_id = #{parentId},
            </if>
            <if test="parentIds != null">
                parent_ids = #{parentIds},
            </if>
            <if test="href != null">
                href = #{href},
            </if>
            <if test="icon != null">
                icon = #{icon},
            </if>
            <if test="isShow != null">
                is_show = #{isShow},
            </if>
            <if test="permission != null">
                permission = #{permission},
            </if>
            <if test="remarks != null">
                remarks = #{remarks},
            </if>
        </set>
        where id = #{id}
    </update>

    <update id="deleteMenuLogic">
        UPDATE TS_MENU set valid_flag = ${@com.adc.da.util.constant.DeleteFlagEnum@DELETE.getValue()}
        WHERE id in
        <foreach collection="array" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- 根据id查询 TS_MENU -->
    <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Integer">
        select
        <include refid="Base_Column_List"/>
        from TS_MENU
        where id = #{value} and valid_flag = ${@com.adc.da.util.constant.DeleteFlagEnum@NORMAL.getValue()}

    </select>

    <!-- 删除记录 -->
    <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
        DELETE FROM TS_MENU
        WHERE id = #{value}
    </delete>


    <delete id="deleteRoleMenus">
        DELETE FROM TR_ROLE_MENU where MENU_ID in
        <foreach collection="array" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        or MENU_ID in (
          select ID from TS_MENU where
            <foreach collection="array" item="id" open="" separator="or" close="">
                PARENT_IDS like '%'||#{id}||'%'
            </foreach>
        )
    </delete>

    <!-- TS_MENU 列表总数-->
    <select id="queryByCount" resultType="java.lang.Integer" parameterType="com.adc.da.base.page.BasePage">
        select count(1) from TS_MENU
        <include refid="Base_Where_Clause"/>
    </select>

    <!-- 查询TS_MENU列表 -->
    <select id="queryByList" resultMap="BaseResultMap" parameterType="com.adc.da.base.page.BasePage">
        select
        <include refid="Base_Column_List"/>
        from (select t.*,rownum rownu from TS_MENU t
        where rownum&lt;=${pager.endIndex})tt
        where tt.rownu>=${pager.startIndex}
    </select>

    <select id="findAll" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM TS_MENU
        WHERE valid_flag = ${@com.adc.da.util.constant.DeleteFlagEnum@NORMAL.getValue()} 
        ORDER BY IS_SHOW ASC
    </select>
	
	<!-- 屏蔽掉 禁止的，只显示启动的 菜单 -->
    <select id="listMenuEOByUserId" resultMap="BaseResultMap">
        SELECT distinct
        M.id, M.valid_flag, M.name, M.parent_id, M.parent_ids, M.href, M.icon, M.is_show, M.permission, M.remarks, M.sort, M.ext_info
        FROM TS_MENU M
            LEFT JOIN TR_ROLE_MENU RM ON RM.MENU_ID = M.ID
            LEFT JOIN TR_USER_ROLE UR ON UR.ROLE_ID = RM.ROLE_ID 
            LEFT JOIN TS_ROLE TR ON TR.ID = UR.ROLE_ID 
        WHERE UR.USER_ID = #{userId} AND TR.USE_FLAG = 0
        ORDER BY M.IS_SHOW ASC
    </select>

    <select id="getChildMenus" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM TS_MENU
        WHERE PARENT_IDS like '%' || #{parentId} || '%'
    </select>

    <select id="isBelong" resultType="integer">
        SELECT count(1) from TR_ROLE_MENU where ROLE_ID = #{roleId} and MENU_ID = #{menuId}
    </select>

    <select id="listMenuEOByRoleID" resultType="com.adc.da.sys.entity.MenuEO">
        SELECT <include refid="Base_Column_List"/> FROM TS_MENU M LEFT JOIN TR_ROLE_MENU RM ON M.ID = RM.MENU_ID where RM.ROLE_ID = #{roleId}
    </select>

</mapper>
